import{_ as D,C as O,m as P}from"./index-DxBgaWc1.js";import{I as L,C as _,g as x}from"./App-D3HmYmVk.js";class T extends _{constructor(e){super(e)}get aspectRatio(){return this.item.settings.isStereo?this.pageWidth/2/this.pageHeight:this.pageWidth/this.pageHeight}calcRow(e,s,r){const o=r/this.aspectRatio+x.chunkGapReal;return s.push({offset:e,height:o,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:o}),o}component({lines:e,width:s,columnIdx:r},o){if(this.item.settings.backgroundMode)return[P("div")];const p={display:"flex",alignItems:"center",justifyContent:x.noStereo?"center":r?"left":"right"},c={backgroundRepeat:"no-repeat",backgroundImage:`url(${this.url})`,backgroundSize:"cover",backgroundPosition:(this.item.settings.isStereo&&r?"right":"left")+" center"};this.item.settings.fitWidth?(c.height=o.height-x.chunkGapReal+"px",c.width="100%",p.height=Math.max(window.innerHeight,o.height-x.chunkGapReal)+"px"):(c.height=Math.min(this.bitmap.height,o.height-x.chunkGapReal)+"px",c.width=Math.min(this.bitmap.width/(this.item.settings.isStereo?2:1),s)+"px",p.height=Math.max(window.innerHeight,parseInt(c.width)/this.aspectRatio)+"px");const g=P("div",{style:c});return[P("div",{idx:e?.[0],style:p},[g])]}}const W=new Set(["fontSize","readingProgress","fontWeight","alternateCharOpacity"]);class E extends L{infoVersion=1.02;get iconColor(){return"#FFC22B"}get icon(){return"image"}get listItemBackground(){return"#443322"}get settingsToStore(){return["width","gap","noStereo","showLineNumbers"]}get settingsToOverride(){return{chunkGapReal:0}}get recalcProps(){return[this.settings.isStereo]}supports(e){return!W.has(e)}constructor(){super();const e=["length"];for(const s of e)Object.defineProperty(this,s,{writable:!0,configurable:!1,enumerable:!1,value:this[s]});this.settings.fitWidth??=!0}onOpen(){this.watch(()=>this.settings.isStereo,()=>this.parseInfo()),this.watch(()=>this.thumbnailUrl,()=>this.save())}async parseInfo(){const{ImageUtils:e}=await D(async()=>{const{ImageUtils:s}=await import("./image-Cl8duVbC.js");return{ImageUtils:s}},[]);this.thumbnailUrl=await e.scaleToDataURL(this.data,this.mimeType,3e4,300,"jpeg",{half:this.settings.isStereo})}async parseData(){const e=O(this),s=new Blob([e.data],{type:e.mimeType}),r=await createImageBitmap(s);return e._chunks.push(new T({blob:s,bitmap:r,url:URL.createObjectURL(s),offset:0,idx:e._chunks.length,pageIdx:0,pageWidth:r.width,pageHeight:r.height,item:e})),Object.assign(e,{length:1}),this}get chunks(){return this._chunks}async addDepthMap(e){const s=this.chunks[0].blob,r=await m(s),o=await I(e,r.width,r.height),p=await M({source:s,depthMap:o,displaceByPixels:200}),c=await M({source:s,depthMap:o,displaceByPixels:-200}),g=await m(p),b=await m(c),w=g.width,B=g.height,y=new OffscreenCanvas(w*2,B),k=y.getContext("2d");k.drawImage(g,0,0),k.drawImage(b,w,0);const C=await y.convertToBlob({type:"image/png"}),R=v(this.fileName)+"-stereo.png";i(C,R);async function m(n){return await createImageBitmap(n)}async function I(n,a,h){const t=await createImageBitmap(n,{resizeWidth:a,resizeHeight:h,resizeQuality:"high"}),l=new OffscreenCanvas(a,h);return l.getContext("2d").drawImage(t,0,0),await l.convertToBlob({type:"image/png"})}function v(n){const a=n.lastIndexOf(".");return a===-1?n:n.slice(0,a)}function i(n,a){const h=URL.createObjectURL(n),t=document.createElement("div");t.style.position="fixed",t.style.right="16px",t.style.bottom="16px",t.style.padding="12px 16px",t.style.background="#1e1e1e",t.style.border="1px solid #444",t.style.borderRadius="6px",t.style.zIndex="9999",t.style.fontFamily="system-ui, sans-serif",t.style.fontSize="13px",t.style.color="#fff";const l=document.createElement("div");l.textContent="Stereo image ready",l.style.marginBottom="6px";const d=document.createElement("a");d.href=h,d.download=a,d.textContent="Download",d.style.color="#4ea1ff",d.style.textDecoration="underline",d.style.cursor="pointer";const u=document.createElement("span");u.textContent="Ã—",u.style.marginLeft="12px",u.style.cursor="pointer",u.style.color="#aaa",u.onclick=()=>{t.remove(),URL.revokeObjectURL(h)},t.appendChild(l),t.appendChild(d),t.appendChild(u),document.body.appendChild(t)}}}async function M(f){const e=Math.min(6,navigator.hardwareConcurrency||1),s=await m(f.source),r=await m(f.depthMap);if(s.width!==r.width||s.height!==r.height)throw new Error("Source and depth map dimensions must match");const o=s.width,p=s.height,c=I(s),g=I(r),b=Math.ceil(p/e),w=[];for(let i=0;i<e;i++){const n=i*b,a=Math.min(p,n+b);if(n>=a)break;const h=v(c.data,o,n,a),t=v(g.data,o,n,a),l=R(),d=new Promise(u=>{l.onmessage=S=>{const U=new Uint8ClampedArray(S.data.buffer);u(new ImageData(U,o,a-n)),l.terminate()}});l.postMessage({source:h.buffer,depth:t.buffer,width:o,height:a-n,displaceByPixels:f.displaceByPixels},[h.buffer,t.buffer]),w.push(d)}const B=await Promise.all(w),y=new OffscreenCanvas(o,p),k=y.getContext("2d");let C=0;for(const i of B)k.putImageData(i,0,C),C+=i.height;return await y.convertToBlob({type:"image/png"});function R(){const i=`
self.onmessage = e => {
    const { source, depth, width, height, displaceByPixels } = e.data;

    const src = new Uint8ClampedArray(source);
    const dep = new Uint8ClampedArray(depth);
    const out = new Uint8ClampedArray(src.length);

    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            const d = dep[i] / 255;
            const dx = Math.round(d * displaceByPixels);
            const sx = Math.min(width - 1, Math.max(0, x + dx));
            const si = (y * width + sx) * 4;

            out[i]     = src[si];
            out[i + 1] = src[si + 1];
            out[i + 2] = src[si + 2];
            out[i + 3] = src[si + 3];
        }
    }

    self.postMessage({ buffer: out.buffer }, [out.buffer]);
};
        `,n=new Blob([i],{type:"application/javascript"});return new Worker(URL.createObjectURL(n))}async function m(i){return await createImageBitmap(i)}function I(i){const a=new OffscreenCanvas(i.width,i.height).getContext("2d");return a.drawImage(i,0,0),a.getImageData(0,0,i.width,i.height)}function v(i,n,a,h){const t=n*4;return i.slice(a*t,h*t)}}export{E as ItemImage,E as default,M as displacePixels};
