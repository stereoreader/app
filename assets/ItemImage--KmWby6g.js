import{I as d,t as f,C as w,g as u,h as b}from"./index-B_GRZTzH.js";class y extends w{constructor(t){super(t)}get aspectRatio(){return this.item.settings.isStereo?this.pageWidth/2/this.pageHeight:this.pageWidth/this.pageHeight}calcRow(t,n,a){const o=a/this.aspectRatio+u.chunkGap;return n.push({offset:t,height:o,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:o}),o}component({lines:t,width:n,columnIdx:a},o){const r={backgroundRepeat:"no-repeat",height:o.height-u.chunkGap+"px",backgroundImage:`url(${this.url})`,backgroundSize:"cover",backgroundPosition:(this.item.settings.isStereo&&a?"right":"left")+" center"};return[b("div",{idx:t?.[0],style:r})]}}const x=new Set(["fontSize","readingProgress","fontWeight","alternateCharOpacity"]);class v extends d{iconColor="#FFC22B";icon="image";get settingsToStore(){return["width","gap","noStereo","showLineNumbers"]}get recalcProps(){return[this.settings.isStereo]}supports(t){return!x.has(t)}constructor(){super();const t=["length"];for(const n of t)Object.defineProperty(this,n,{writable:!0,configurable:!1,enumerable:!1,value:this[n]})}async parseInfo(){this.thumbnailUrl=await R(this.data,this.mimeType,100,100)}async parseData(){const t=f(this),n=new Blob([t.data],{type:t.mimeType}),a=await createImageBitmap(n);return t._chunks.push(new y({blob:n,bitmap:a,url:URL.createObjectURL(n),offset:0,idx:t._chunks.length,pageIdx:0,pageWidth:a.width,pageHeight:a.height,item:t})),Object.assign(t,{length:1}),this}get chunks(){return this._chunks}}async function R(e,t,n,a){const o=await C(e,t);try{const{width:r,height:i}=o;if(r===0||i===0)throw new Error("Decoded image has zero dimensions.");const s=Math.min(n/r,a/i),c=Math.max(1,Math.round(r*s)),g=Math.max(1,Math.round(i*s)),{canvas:p,ctx:h}=l(c,g);return h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",h.clearRect(0,0,c,g),h.drawImage(o,0,0,c,g),await B(p)}finally{try{typeof o.close=="function"&&o.close()}catch{}}}async function C(e,t){const n=new Blob([e],{type:t});return typeof createImageBitmap=="function"?await createImageBitmap(n):await new Promise((a,o)=>{const r=URL.createObjectURL(n),i=new Image;i.onload=async()=>{try{const{canvas:s,ctx:c}=l(i.naturalWidth,i.naturalHeight);c.drawImage(i,0,0),URL.revokeObjectURL(r);const g=await I(s);a(g)}catch(s){o(s)}},i.onerror=()=>{URL.revokeObjectURL(r),o(new Error("Failed to decode image."))},i.src=r})}function l(e,t){if(typeof OffscreenCanvas<"u"){const o=new OffscreenCanvas(e,t),r=o.getContext("2d");if(!r)throw new Error("Could not get 2D context.");return{canvas:o,ctx:r}}const n=document.createElement("canvas");n.width=e,n.height=t;const a=n.getContext("2d");if(!a)throw new Error("Could not get 2D context.");return{canvas:n,ctx:a}}async function I(e){if("transferToImageBitmap"in e&&typeof e.transferToImageBitmap=="function")return e.transferToImageBitmap();const t=await m(e);return await createImageBitmap(t)}async function m(e){return"convertToBlob"in e&&typeof e.convertToBlob=="function"?await e.convertToBlob({type:"image/png"}):await new Promise((t,n)=>{e.toBlob(a=>{if(!a){n(new Error("Canvas toBlob failed."));return}t(a)},"image/png")})}async function B(e){if(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)return e.toDataURL("image/png");const t=await m(e);return await L(t)}function L(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(String(a.result)),a.onerror=()=>n(new Error("Failed to read blob as data URL.")),a.readAsDataURL(e)})}export{v as ItemImage,v as default,R as scaleImageToPngDataURL};
