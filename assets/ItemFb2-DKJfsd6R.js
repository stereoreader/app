import{I as c,t as w,C as f,g as m,h as x,n as y}from"./index-C_XF0ui1.js";class C extends f{async onClick(i){const e=this.item.outline;c.current=null,await y(),c.current=e,Object.assign(e.readingProgressDetails,{chunkIdx:this.chunkIdx,chunkPos:0,screenY:0})}}class I extends f{width=0;height=0;get ratio(){return this.width/this.height}constructor(i){super(i),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const e=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!e)throw new Error("Cannot extract fb2 image href");const s=this.item.binaries[e],o=atob(s.textContent),r=new Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const u=new Uint8Array(r),l=new Blob([u],{type:s.getAttribute("content-type")});this.url=URL.createObjectURL(l);const{promise:a,resolve:g}=Promise.withResolvers(),t=new Image;return t.onload=()=>{this.width=t.width,this.height=t.height,g()},t.src=this.url,a}calcRow(i,e,s){const{style:o}=this,r=Math.min(s,this.width)/this.ratio+m.chunkGap;return e.push({offset:i,height:r,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],rowHeight:r}),r}component(i,e){const s={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:e.height-m.chunkGap+"px",backgroundSize:"contain"},o=c.current.activeChunk.idx===this.idx;return o&&(s.backgroundColor=m.cursorBackgroundColor),[x("div",{idx:i?.lines?.[0],class:{active:o},style:s})]}}class b extends c{binaries={};loaders=[];iconColor="#44ff88";static _private=["length","binaries","loaders"];constructor(){super();for(const i of b._private)Object.defineProperty(this,i,{writable:!0,configurable:!1,enumerable:!1,value:this[i]})}async parseData(){const i=new DOMParser().parseFromString(this.data,"text/xml"),e=w(this);let s=0,o=0;const r=c.create({title:this.title,isOutline:!0,chunked:!0,mimeType:"text/fb2",id:this.id+"_outline"});e.outline=r,r.outline=e;const u=(t,n)=>{t.trim().match(/^\[?\s*\d+\s*\]?$/)&&(n="title"),e._chunks.push(new f({text:t,offset:s,idx:e._chunks.length,type:n,item:e})),s+=t.length,n==="title"&&(r._chunks.push(new C({chunkIdx:e._chunks.length-1,text:t,offset:o,idx:r._chunks.length,item:r,type:n})),o+=t.length)},l=i.documentElement.querySelector("description > title-info > coverpage > image");l&&a([l],"description");for(const t of g(i.documentElement.children))t.tagName==="body"?a(t.children,"body"):t.tagName==="binary"&&(this.binaries[t.id]=t);return Object.assign(e,{length:s}),await Promise.all(e.loaders.map(t=>t())),Object.assign(r,{length:o}),e.chunked=!0,this;function a(t,n){for(let d=0;d<t.length;d++){const h=t[d];if(h.tagName==="image"){const p=new I({offset:s,idx:e._chunks.length,elem:h,type:"image",item:e});e._chunks.push(p),s++}else h.tagName==="p"||!h.children.length?u(h.textContent,n):a(h.children,h.tagName)}}function*g(t){for(let n=0;n<t.length;n++)yield t[n]}}get chunks(){return this._chunks}}export{b as ItemFb2};
