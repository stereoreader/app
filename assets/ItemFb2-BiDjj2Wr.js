import{I as l,t as x,C as k,a as b,h as y,n as C}from"./index-ATaEJjKZ.js";class I extends k{async onClick(n){const t=this.item.outline;l.current=null,await C(),l.current=t,Object.assign(t.readingProgressDetails,{chunkIdx:this.chunkIdx,chunkPos:0,screenY:.01})}}class N extends k{width=0;height=0;get ratio(){return this.width/this.height}constructor(n){super(n),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const t=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!t)throw new Error("Cannot extract fb2 image href");const i=this.item.binaries[t],r=atob(i.textContent),s=new Array(r.length);for(let a=0;a<r.length;a++)s[a]=r.charCodeAt(a);const m=new Uint8Array(s),u=new Blob([m],{type:i.getAttribute("content-type")});this.url=URL.createObjectURL(u);const{promise:d,resolve:g}=Promise.withResolvers(),c=new Image;return c.onload=()=>{this.width=c.width,this.height=c.height,g()},c.src=this.url,d}calcRow(n,t,i){const{style:r}=this,s=Math.min(i,this.width)/this.ratio+b.chunkGap;return t.push({offset:n,height:s,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],rowHeight:s}),s}component=(n,t)=>{const i={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:t.height-b.chunkGap+"px",backgroundSize:"contain"},r=l.current.activeChunk.idx===this.idx;return r&&(i.backgroundColor=b.cursorBackgroundColor),[y("div",{idx:n?.lines?.[0],class:{active:r},style:i})]}}class S extends l{binaries={};loaders=[];iconColor="#44ff88";constructor(){super();const n=["length","binaries","loaders"];for(const t of n)Object.defineProperty(this,t,{writable:!0,configurable:!1,enumerable:!1,value:this[t]})}async parseData(){const n=new DOMParser().parseFromString(this.data,"text/xml"),t=x(this);let i=0,r=0;const s=l.create({title:this.title,isOutline:!0,chunked:!0,mimeType:"text/fb2",id:this.id+"_outline"});t.outline=s,s.outline=t;const m=(e,o)=>{e.trim().match(/^\[?\s*\d+\s*\]?$/)&&(o="title"),t._chunks.push(new k({text:e,offset:i,idx:t._chunks.length,type:o,item:t})),i+=e.length,o==="title"&&e.trim()&&(s._chunks.push(new I({chunkIdx:t._chunks.length-1,text:e,offset:r,idx:s._chunks.length,item:s,type:o})),r+=e.length)},u=n.documentElement.querySelector("description > title-info > book-title")?.textContent;u&&(t.title=u);const d=n.documentElement.querySelector("description > title-info > author");d&&(t.author=[...d.children].map(e=>e.textContent.trim()).filter(Boolean).join(" "));const g=n.documentElement.querySelector("description > title-info > coverpage > image");g&&c([g],"description");for(const e of a(n.documentElement.children))e.tagName==="body"?c(e.children,"body"):e.tagName==="binary"&&(this.binaries[e.id]=e);return Object.assign(t,{length:i}),await Promise.all(t.loaders.map(e=>e())),Object.assign(s,{length:r}),t.chunked=!0,this;function c(e,o){for(let f=0;f<e.length;f++){const h=e[f];if(h.tagName==="image"){const w=new N({offset:i,idx:t._chunks.length,elem:h,type:"image",item:t});t._chunks.push(w),i++}else h.tagName==="p"||!h.children.length?m(h.textContent,o):c(h.children,h.tagName)}}function*a(e){for(let o=0;o<e.length;o++)yield e[o]}}get chunks(){return this._chunks}}export{S as ItemFb2};
