import{I as m,t as u}from"./index-CZMJojAI.js";import{ImageUtils as f}from"./image-Cl8duVbC.js";function*h(d){for(let e=0;e<d.length;e++)yield d[e]}class b extends m{binaries={};get iconColor(){return"#44ff88"}get icon(){return"fb2-file"}constructor(){super();const e=["binaries","parsed"];for(const n of e)Object.defineProperty(this,n,{writable:!0,configurable:!1,enumerable:!1,value:this[n]})}loadBinary(e){const r=e.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!r)throw new Error("Cannot extract fb2 image href");const t=this.binaries[r],a=f.decodeBase64ToBytes(t.textContent);return new Blob([a],{type:t.getAttribute("content-type")})}async parseInfo(){await super.parseInfo(),this.parsed=new DOMParser().parseFromString(this.data,"text/xml");for(const t of h(this.parsed.documentElement.children))t.tagName==="binary"&&(this.binaries[t.id]=t);const e=this.parsed.documentElement.querySelector("description > title-info > coverpage > image");if(e){const t=this.loadBinary(e);this.thumbnailUrl=await f.scaleToDataURL(t,null,3e4,300,"jpeg")}const n=this.parsed.documentElement.querySelector("description > title-info > book-title")?.textContent;n&&(this.title=n);const r=this.parsed.documentElement.querySelector("description > title-info > author");r&&(this.author=[...r.children].map(t=>t.textContent.trim()).filter(Boolean).join(" "))}async parseData(){const e=u(this);let n=0;if(!this.parsed){this.parsed=new DOMParser().parseFromString(this.data,"text/xml");for(const i of h(this.parsed.documentElement.children))i.tagName==="binary"&&(this.binaries[i.id]=i)}const r=(i,o,c)=>{o==="subtitle"&&(c++,o="title");const l=e.addChunk({text:i,type:o});o==="title"&&i&&e.addOutlineChunk({text:i,chunkIdx:l.idx,level:c})},t=this.parsed.documentElement.querySelector("description > title-info > coverpage > image");t&&a([t],"description");for(const i of h(this.parsed.documentElement.children))i.tagName==="body"&&a(i.children,"body");return this;function a(i,o,c=0){for(let l=0;l<i.length;l++){const s=i[l];s.tagName==="image"?(e.addImageChunk({offset:n,idx:e._chunks.length},async()=>e.loadBinary(s)),n++):s.tagName==="p"||!s.children.length?r(s.textContent,o,c):a(s.children,s.tagName,c+1)}}}get chunks(){return this._chunks}}export{b as ItemFb2,b as default};
