import{I as w,t as x}from"./index-CZMJojAI.js";class R extends w{files={};rels={};contentTypes={};documentPath="";documentRelsPath="";stylesPath="";corePropsPath="";media={};static mimeType="text/docx";get iconColor(){return"#3B82F6"}get icon(){return"docx"}constructor(){super();const e=["files","rels","contentTypes","media"];for(const a of e)Object.defineProperty(this,a,{writable:!0,configurable:!1,enumerable:!1,value:this[a]})}get chunks(){return this._chunks}async unzip(){if(!Object.keys(this.files).length)for await(const e of w.unzip(new File([this.data],this.fileName)))this.files[e.name]=await e.content()}parseXml(e){if(!(e in this.files))throw new Error(`DOCX: trying to access non-existing file ${e}`);return new DOMParser().parseFromString(new TextDecoder().decode(this.files[e]),"text/xml")}extractPackage(){if(this.documentPath)return;const e=x(this);if("[Content_Types].xml"in e.files){const t=e.parseXml("[Content_Types].xml");for(const n of t.querySelectorAll("Types > Default")){const o=n.getAttribute("Extension"),s=n.getAttribute("ContentType");o&&s&&(e.contentTypes["."+o.toLowerCase()]=s)}for(const n of t.querySelectorAll("Types > Override")){const o=n.getAttribute("PartName"),s=n.getAttribute("ContentType");o&&s&&(e.contentTypes[o.replace(/^\//,"")]=s)}}const a="_rels/.rels",p=e.parseXml(a);e.rels[a]=y(p);const f=e.rels[a].find(t=>t.type==="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument");if(!f)throw new Error("DOCX: cannot find officeDocument relationship in _rels/.rels");if(e.documentPath=g(f.target),e.documentRelsPath=N(e.documentPath),e.documentRelsPath in e.files){const t=e.parseXml(e.documentRelsPath);e.rels[e.documentRelsPath]=y(t)}else e.rels[e.documentRelsPath]=[];const h=e.rels[e.documentRelsPath].find(t=>t.type==="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles");h?e.stylesPath=g(b(e.documentPath,h.target)):"word/styles.xml"in e.files&&(e.stylesPath="word/styles.xml");const d=e.rels[a].find(t=>t.type==="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties");d?e.corePropsPath=g(d.target):"docProps/core.xml"in e.files&&(e.corePropsPath="docProps/core.xml");for(const[t,n]of Object.entries(e.files)){if(!t.startsWith("word/media/"))continue;const o=l(t,e.contentTypes);e.media[t]=new Blob([n],{type:o??""})}function y(t){const n=[],o=t.getElementsByTagName("Relationship");for(let s=0;s<o.length;s++){const r=o[s],i=r.getAttribute("Id"),c=r.getAttribute("Type"),u=r.getAttribute("Target"),m=r.getAttribute("TargetMode")??void 0;i&&c&&u&&n.push({id:i,type:c,target:u,targetMode:m})}return n}function N(t){const n=t.split("/"),o=n.pop()??"";return[...n,"_rels",o+".rels"].join("/")}function g(t){return t.replace(/^\//,"")}function b(t,n){const s="https://fake.local/"+(t.includes("/")?t.replace(/\/[^\/]+$/,"/"):"");return new URL(n,s).href.replace("https://fake.local/","")}function l(t,n){const o=t.toLowerCase();if(o in n)return n[o];const s=o.match(/\.[a-z0-9]+$/)?.[0]??"";return s&&s in n?n[s]:/\.jpe?g$/.test(o)?"image/jpeg":/\.png$/.test(o)?"image/png":/\.gif$/.test(o)?"image/gif":/\.svg$/.test(o)?"image/svg+xml":/\.webp$/.test(o)?"image/webp":null}}async parseInfo(){const e=x(this);if(await e.unzip(),e.extractPackage(),e.corePropsPath&&e.corePropsPath in e.files){const a=e.parseXml(e.corePropsPath),p=a.querySelector("title")?.textContent?.trim(),f=a.querySelector("creator")?.textContent?.trim();p?e.title=p:e.title||(e.title=e.fileName),f&&(e.author=f)}else e.title=e.title||e.fileName}async parseData(){const e=x(this);await e.unzip(),e.extractPackage();const a=h(e.stylesPath?e.parseXml(e.stylesPath):null),f=e.parseXml(e.documentPath).getElementsByTagNameNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","body")[0];if(!f)return this;for(const l of f.childNodes)if(l instanceof Element){if(l.localName==="p"){const{text:t,hasImage:n,imageRelIds:o}=y(l),s=d(l,a);if(s!==null){const i=t.trim();if(i){const c=e.addChunk({text:i,type:"title"});e.addOutlineChunk({text:i,chunkIdx:c.idx,level:s})}continue}if(n&&o.length)for(const i of o)e.addImageChunk({},async()=>{const c=b(e,i);if(!c)throw new Error(`DOCX: cannot resolve image relationship ${i}`);return c});const r=t.trim();r&&e.addChunk({text:r,type:"p"});continue}if(l.localName==="tbl"){const t=N(l).trim();t&&e.addChunk({text:t,type:"table"});continue}}return this;function h(l){const t={};if(!l)return t;const n="http://schemas.openxmlformats.org/wordprocessingml/2006/main",o=l.getElementsByTagNameNS(n,"style");for(let s=0;s<o.length;s++){const r=o[s],i=r.getAttributeNS(n,"styleId")??r.getAttribute("w:styleId")??r.getAttribute("styleId");if(!i)continue;const c=r.getElementsByTagNameNS(n,"name")[0]?.getAttributeNS(n,"val")??r.getElementsByTagNameNS(n,"name")[0]?.getAttribute("w:val")??"",u=r.getElementsByTagNameNS(n,"outlineLvl")[0]?.getAttributeNS(n,"val")??r.getElementsByTagNameNS(n,"outlineLvl")[0]?.getAttribute("w:val")??null;if(u!==null){const m=parseInt(u,10);Number.isNaN(m)||(t[i]=m)}else{const m=c.match(/Heading\s*(\d+)/i)??i.match(/^Heading(\d+)$/i);if(m){const P=parseInt(m[1],10)-1;!Number.isNaN(P)&&P>=0&&(t[i]=P)}}}return t}function d(l,t){const n="http://schemas.openxmlformats.org/wordprocessingml/2006/main",o=l.getElementsByTagNameNS(n,"pPr")[0];if(!o)return null;const s=o.getElementsByTagNameNS(n,"pStyle")[0],r=s?.getAttributeNS(n,"val")??s?.getAttribute("w:val")??null;if(r&&r in t)return t[r];const i=o.getElementsByTagNameNS(n,"outlineLvl")[0],c=i?.getAttributeNS(n,"val")??i?.getAttribute("w:val")??null;if(c!==null){const u=parseInt(c,10);if(!Number.isNaN(u))return u}if(r){const u=r.match(/^Heading(\d+)$/i);if(u){const m=parseInt(u[1],10)-1;if(!Number.isNaN(m)&&m>=0)return m}}return null}function y(l){const t=[];return{text:N(l,t),hasImage:t.length>0,imageRelIds:t}}function N(l,t){const n=[],o=[l];for(;o.length;){const s=o.pop();if(s instanceof Element){s.localName==="t"?n.push(s.textContent??""):s.localName==="tab"?n.push("\\t"):s.localName==="br"||s.localName==="cr"?n.push("\\n"):(s.localName==="drawing"||s.localName==="pict")&&g(s,t);for(let r=s.childNodes.length-1;r>=0;r--)o.push(s.childNodes[r])}}return n.join("")}function g(l,t){if(!t)return;const n=l.getElementsByTagNameNS("http://schemas.openxmlformats.org/drawingml/2006/main","blip");for(let o=0;o<n.length;o++){const s=n[o],r=s.getAttribute("r:embed")??s.getAttributeNS("http://schemas.openxmlformats.org/officeDocument/2006/relationships","embed");r&&t.push(r)}}function b(l,t){const n=l.rels[l.documentRelsPath]?.find(i=>i.id===t);if(!n||n.targetMode==="External")return null;const s=`https://fake.local/${l.documentRelsPath.includes("/_rels/")?l.documentRelsPath.replace(/\/_rels\/[^\/]+\.rels$/,"/"):l.documentRelsPath.includes("/")?l.documentRelsPath.replace(/\/[^\/]+$/,"/"):""}`,r=new URL(n.target,s).pathname.replace(/^\//,"").replace(/\\/g,"/");return l.media[r]??null}}}export{R as ItemDocx,R as default};
