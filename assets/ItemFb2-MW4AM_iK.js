import{I as h,t as k,C as f,g as m,h as w,n as x}from"./index-CThxUJM8.js";class y extends f{async onClick(i){const t=this.item.outline;h.current=null,await x(),h.current=t,Object.assign(t.readingProgressDetails,{chunkIdx:this.chunkIdx,chunkPos:0,screenY:.01})}}class C extends f{width=0;height=0;get ratio(){return this.width/this.height}constructor(i){super(i),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const t=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!t)throw new Error("Cannot extract fb2 image href");const n=this.item.binaries[t],r=atob(n.textContent),o=new Array(r.length);for(let s=0;s<r.length;s++)o[s]=r.charCodeAt(s);const u=new Uint8Array(o),l=new Blob([u],{type:n.getAttribute("content-type")});this.url=URL.createObjectURL(l);const{promise:c,resolve:d}=Promise.withResolvers(),e=new Image;return e.onload=()=>{this.width=e.width,this.height=e.height,d()},e.src=this.url,c}calcRow(i,t,n){const{style:r}=this,o=Math.min(n,this.width)/this.ratio+m.chunkGapReal;return t.push({offset:i,height:o,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:o}),o}component=(i,t)=>{const n={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:t.height-m.chunkGapReal+"px",backgroundSize:"contain"},r=h.current.activeChunk.idx===this.idx;return r&&(n.backgroundColor=m.cursorBackgroundColor),[w("div",{idx:i?.lines?.[0],class:{active:r},style:n})]}}class N extends h{binaries={};loaders=[];iconColor="#44ff88";icon="fb2-file";constructor(){super();const i=["length","binaries","loaders"];for(const t of i)Object.defineProperty(this,t,{writable:!0,configurable:!1,enumerable:!1,value:this[t]})}async parseInfo(){await super.parseInfo();const i=new DOMParser().parseFromString(this.data,"text/xml"),t=i.documentElement.querySelector("description > title-info > book-title")?.textContent;t&&(this.title=t);const n=i.documentElement.querySelector("description > title-info > author");n&&(this.author=[...n.children].map(r=>r.textContent.trim()).filter(Boolean).join(" "))}async parseData(){const i=new DOMParser().parseFromString(this.data,"text/xml"),t=k(this);let n=0,r=0;const o=h.create({title:this.title,isOutline:!0,chunked:!0,mimeType:"text/fb2",id:this.id+"_outline"});t.outline=o,o.outline=t;const u=(e,s)=>{e.trim().match(/^\[?\s*\d+\s*\]?$/)&&(s="title"),t._chunks.push(new f({text:e,offset:n,idx:t._chunks.length,type:s,item:t})),n+=e.length,s==="title"&&e.trim()&&(o._chunks.push(new y({chunkIdx:t._chunks.length-1,text:e,offset:r,idx:o._chunks.length,item:o,type:s})),r+=e.length)},l=i.documentElement.querySelector("description > title-info > coverpage > image");l&&c([l],"description");for(const e of d(i.documentElement.children))e.tagName==="body"?c(e.children,"body"):e.tagName==="binary"&&(this.binaries[e.id]=e);return Object.assign(t,{length:n}),await Promise.all(t.loaders.map(e=>e())),Object.assign(o,{length:r}),t.chunked=!0,this;function c(e,s){for(let g=0;g<e.length;g++){const a=e[g];if(a.tagName==="image"){const p=new C({offset:n,idx:t._chunks.length,elem:a,type:"image",item:t});t._chunks.push(p),n++}else a.tagName==="p"||!a.children.length?u(a.textContent,s):c(a.children,a.tagName)}}function*d(e){for(let s=0;s<e.length;s++)yield e[s]}}get chunks(){return this._chunks}}export{N as ItemFb2,N as default};
