import{C as g,_ as x}from"./index-yM_T8tNe.js";import{I as b}from"./App-DHyjxk6P.js";class v extends b{resources={};spine=[];toc=[];files={};opfDir="";meta={};manifest={};static mimeType="application/epub+zip";get iconColor(){return"#00C2FF"}get icon(){return"epub"}constructor(){super();const t=["resources","spine","toc","files","opf","manifest"];for(const e of t)Object.defineProperty(this,e,{writable:!0,configurable:!1,enumerable:!1,value:this[e]})}get chunks(){return this._chunks}async unzip(){if(!Object.keys(this.files).length)for await(const t of b.unzip(new File([this.data],this.fileName)))this.files[t.name]=await t.content()}extractOpf(){if(this.opf)return;const t=g(this),s=t.parseXml("META-INF/container.xml").querySelector("rootfile").getAttribute("full-path");this.opfDir=s.split("/").slice(0,-1).join("/"),this.opf=t.parseXml(s);for(const n of this.opf.querySelectorAll("manifest > item"))this.manifest[n.getAttribute("id")]={href:n.getAttribute("href"),mimeType:n.getAttribute("media-type")}}parseXml(t){if(!(t in this.files))throw new Error(`EPUB: trying to access non-existing file ${t}`);return new DOMParser().parseFromString(new TextDecoder().decode(this.files[t]),"text/xml")}getAbsPath(t){return[this.opfDir,t].filter(Boolean).join("/")}parseXmlAbs(t){return t=this.getAbsPath(t),this.parseXml(t)}parseXmlId(t){const e=this.manifest[t]?.href;return this.parseXmlAbs(e)}async parseInfo(){const t=g(this);await t.unzip(),t.extractOpf();const e=t.opf.querySelector("metadata");if(e){for(const n of e.children)if(n.tagName.toLowerCase().startsWith("dc:")){const c={text:n.textContent};for(const a of n.attributes)if(a.name.startsWith("opf:")){const p=a.name.slice(4).replace(/-\w/,h=>h[1].toUpperCase());c[p]=a.value}(t.meta[n.localName]??=[]).push(c)}}t.title=t.meta.title?.[0]?.text??t.fileName,t.author=t.meta.creator?.[0]?.text??"";const s=t.manifest[e?.querySelector('meta[name="cover"]')?.getAttribute("content")??""];if(s){const{ImageUtils:n}=await x(async()=>{const{ImageUtils:c}=await import("./image-Cl8duVbC.js");return{ImageUtils:c}},[]);this.thumbnailUrl=await n.scaleToDataURL(t.files[this.getAbsPath(s.href)],s.mimeType,3e4,300,"jpeg")}}async parseData(){const t=new Set(["p","div","section","article","li","blockquote"]),e=g(this);await e.unzip(),e.extractOpf();let s;const n=this.opf.querySelector("spine[toc]");if(n){const l=n.getAttribute("toc"),o=e.parseXmlId(l),f=(i,u=0)=>{for(const r of i.children)if(r.localName==="navPoint"){const m=r.querySelector("navLabel>text")?.textContent,d=r.querySelector("content")?.getAttribute("src");d&&m&&(s??={},s[this.getAbsPath(d)]={text:m,level:u}),f(r,u+1)}};f(o.querySelector("navMap"))}for(const[l,o]of Object.entries(e.files))/\.(png|jpe?g|gif|svg)$/i.test(l)&&(e.resources[l]=new Blob([o]));let c,a=null;const p="https://fake.com/";for(const l of this.opf.querySelectorAll("spine > itemref")){const o=l.getAttribute("idref");c=this.getAbsPath(this.manifest[o].href);const f=this.parseXml(c);a=s?.[c],h(f.body)}return this;function h(l){let o="";if(!l.childNodes.length)return l.textContent??"";for(const i of l.childNodes)if(i instanceof Element){const u=i.getAttribute("id");if(u&&s){const r=c+"#"+u;if(r in s){if(a)debugger;a=s[r]}}if(i.localName==="svg")continue;if(i.localName==="img"||i.localName==="image"){const r=i.getAttribute("src");if(!r)continue;f(),e.addImageChunk({},async()=>{const m=new URL(r,p+c).href.slice(p.length);return e.resources[m]});continue}if(/^h[1-6]$/.test(i.localName)){f(i.textContent??"","title");continue}if(t.has(i.localName)){o+=h(i),f();continue}o+=h(i)}else o+=h(i);return o;function f(i,u){if(o.length){const d=o;o="",f(d,"p")}const r=i?.trim();if(!r)return;const m=e.addChunk({text:r,type:u});a&&(e.addOutlineChunk({text:a.text,chunkIdx:m.idx,level:a.level}),a=null)}}}}export{v as ItemEpub,v as default};
