import{I as c,t as w,C as f,g as m,h as x,n as y}from"./index-CiUX_3_A.js";class C extends f{async onClick(i){const t=this.item.outline;c.current=null,await y(),c.current=t,Object.assign(t.readingProgressDetails,{chunkIdx:this.chunkIdx,chunkPos:0,screenY:0})}}class I extends f{width=0;height=0;get ratio(){return this.width/this.height}constructor(i){super(i),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const t=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!t)throw new Error("Cannot extract fb2 image href");const s=this.item.binaries[t],o=atob(s.textContent),r=new Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const u=new Uint8Array(r),l=new Blob([u],{type:s.getAttribute("content-type")});this.url=URL.createObjectURL(l);const{promise:a,resolve:g}=Promise.withResolvers(),e=new Image;return e.onload=()=>{this.width=e.width,this.height=e.height,g()},e.src=this.url,a}calcRow(i,t,s){const{style:o}=this,r=Math.min(s,this.width)/this.ratio+m.chunkGap;return t.push({offset:i,height:r,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],rowHeight:r}),r}component(i,t){debugger;const s={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:t.height-m.chunkGap+"px",backgroundSize:"contain"},o=c.current.activeChunk.idx===this.idx;return o&&(s.backgroundColor=m.cursorBackgroundColor),[x("div",{idx:i?.lines?.[0],class:{active:o},style:s})]}}class b extends c{binaries={};loaders=[];iconColor="#44ff88";static _private=["length","binaries","loaders"];constructor(){super();for(const i of b._private)Object.defineProperty(this,i,{writable:!0,configurable:!1,enumerable:!1,value:this[i]})}async parseData(){const i=new DOMParser().parseFromString(this.data,"text/xml"),t=w(this);let s=0,o=0;const r=c.create({title:this.title,isOutline:!0,chunked:!0,mimeType:"text/fb2",id:this.id+"_outline"});t.outline=r,r.outline=t;const u=(e,n)=>{e.trim().match(/^\[?\s*\d+\s*\]?$/)&&(n="title"),t._chunks.push(new f({text:e,offset:s,idx:t._chunks.length,type:n,item:t})),s+=e.length,n==="title"&&(r._chunks.push(new C({chunkIdx:t._chunks.length-1,text:e,offset:o,idx:r._chunks.length,item:r,type:n})),o+=e.length)},l=i.documentElement.querySelector("description > title-info > coverpage > image");l&&a([l],"description");for(const e of g(i.documentElement.children))e.tagName==="body"?a(e.children,"body"):e.tagName==="binary"&&(this.binaries[e.id]=e);return Object.assign(t,{length:s}),await Promise.all(t.loaders.map(e=>e())),Object.assign(r,{length:o}),t.chunked=!0,this;function a(e,n){for(let d=0;d<e.length;d++){const h=e[d];if(h.tagName==="image"){const p=new I({offset:s,idx:t._chunks.length,elem:h,type:"image",item:t});t._chunks.push(p),s++}else h.tagName==="p"||!h.children.length?u(h.textContent,n):a(h.children,h.tagName)}}function*g(e){for(let n=0;n<e.length;n++)yield e[n]}}get chunks(){return this._chunks}}export{b as ItemFb2};
