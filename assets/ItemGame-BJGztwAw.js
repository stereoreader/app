import{I as h,t as a,s as o,g as l,C as c,h as u}from"./index-ExYHSvxM.js";class g{angleSpread=.5;canvases=[];contexts=[];x=0;y=0;prevX=0;prevY=0;angle=0;lastTime=0;running=!1;rafId=null;resizeObserver=null;removalObserver=null;get speed(){return this.canvas.height*.73529411764}get ballSize(){return o.fontSize}start(t){if(t.length===0)throw new Error("At least one canvas is required");this.stop(),this.canvases=t,this.canvas=t[0],this.contexts=t.map(s=>{const i=s.getContext("2d");if(!i)throw new Error("2D context not available");return i}),this.handleResize(),this.observeResize(),this.observeRemoval();const e=this.canvases[0];this.x=e.width/2,this.y=e.height/2,this.prevX=this.x,this.prevY=this.y,this.angle=Math.random()*Math.PI*2,this.running=!0,this.lastTime=performance.now(),this.loop(this.lastTime)}pause(){this.running=!this.running,this.running&&this.rafId===null&&(this.lastTime=performance.now(),this.loop(this.lastTime))}stop(){this.running=!1,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.resizeObserver?.disconnect(),this.removalObserver?.disconnect(),this.resizeObserver=null,this.removalObserver=null,this.canvases=[],this.contexts=[],this.x=0,this.y=0,this.prevX=0,this.prevY=0,this.angle=0,this.lastTime=0}loop=t=>{if(!this.running){this.rafId=null;return}const e=(t-this.lastTime)/1e3;this.lastTime=t,this.update(e),this.draw(),this.rafId=requestAnimationFrame(this.loop)};update(t){const e=this.canvases[0],s=this.ballSize/2;this.prevX=this.x,this.prevY=this.y,this.x+=Math.cos(this.angle)*this.speed*t,this.y+=Math.sin(this.angle)*this.speed*t;let i=!1;this.x-s<0?(this.x=s,this.angle=Math.PI-this.angle,i=!0):this.x+s>e.width&&(this.x=e.width-s,this.angle=Math.PI-this.angle,i=!0),this.y-s<0?(this.y=s,this.angle=-this.angle,i=!0):this.y+s>e.height&&(this.y=e.height-s,this.angle=-this.angle,i=!0),i&&(this.angle+=this.angleSpread*Math.random())}draw(){const t=this.ballSize/2,e=t*2+2;for(let s=0;s<this.canvases.length;s+=1){const i=this.contexts[s];i.clearRect(this.prevX-t-1,this.prevY-t-1,e,e),i.fillStyle=l.textColor,i.beginPath(),i.arc(this.x,this.y,t,0,Math.PI*2),i.fill()}}handleResize(){const t=this.canvas.getBoundingClientRect(),e=this.ballSize/2;this.x=Math.min(Math.max(this.x,e),t.width-e),this.y=Math.min(Math.max(this.y,e),t.height-e),this.prevX=this.x,this.prevY=this.y}observeResize(){this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.canvas)}observeRemoval(){const t=this.canvas.parentNode;t&&(this.removalObserver=new MutationObserver(e=>{for(const s of e)for(const i of s.removedNodes)if(i===this.canvas){this.stop();return}}),this.removalObserver.observe(t,{childList:!0}))}}class d extends c{game=null;constructor(t){super(t)}calcRow(t,e,s){return e.push({offset:t,height:10,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:10}),10}component({lines:t,width:e,columnIdx:s},i){const r={};return r.style="display: block;position: absolute;left: 0; top:0",r.width=e,r.height=document.querySelector(".reader").clientHeight,u("canvas",{...r})}}const p=new Set(["readingProgress","fontWeight","alternateCharOpacity"]);class f extends h{readerTopPadding=0;readerBottomPadding=0;iconColor="#C2FF2B";icon="game";get settingsToStore(){return["width","gap","fontSize","noStereo"]}get settingsToOverride(){return{showReaderScrollbar:!1}}get recalcProps(){return[this.settings.isStereo]}supports(t){return!p.has(t)}constructor(){super();const t=["length"];for(const e of t)Object.defineProperty(this,e,{writable:!0,configurable:!1,enumerable:!1,value:this[e]});this.settings.fitWidth??=!0}async parseInfo(){}onOpen(){setTimeout(()=>{new g().start([...document.querySelectorAll(".reader canvas")])})}async parseData(){const t=a(this);return t._chunks.push(new d({offset:0,idx:t._chunks.length,pageIdx:0,item:t})),Object.assign(t,{length:1}),this}get chunks(){return this._chunks}}export{f as ItemGame,f as default};
