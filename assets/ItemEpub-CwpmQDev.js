import{I as x,t as g,_ as y,C as k,g as b,h as A}from"./index-CPCZy2I3.js";class v extends k{width=0;height=0;url="";get ratio(){return this.width/this.height}constructor(t){super(t),this.item.loaders.push(this.loadImage.bind(this))}async loadImage(){const t=this.item.resources[this.href];if(!t)throw new Error(`Missing epub image: ${this.href}`);this.url=URL.createObjectURL(t);const{promise:e,resolve:s}=Promise.withResolvers(),i=new Image;return i.onload=()=>{this.width=i.width,this.height=i.height,s()},i.src=this.url,e}calcRow(t,e,s){const i=Math.min(s,this.width)/this.ratio+b.chunkGapReal;return e.push({offset:t,height:i,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:i}),i}component=(t,e)=>{const s={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"contain",height:e.height-b.chunkGapReal+"px"},i=x.current.activeChunk.idx===this.idx;return i&&(s.backgroundColor=b.cursorBackgroundColor),[A("div",{class:{active:i},style:s})]}}class C extends x{resources={};loaders=[];spine=[];toc=[];files={};opfDir="";meta={};manifest={};static mimeType="application/epub+zip";get iconColor(){return"#00C2FF"}get icon(){return"epub"}constructor(){super();const t=["resources","loaders","spine","toc","files","opf","manifest"];for(const e of t)Object.defineProperty(this,e,{writable:!0,configurable:!1,enumerable:!1,value:this[e]})}get chunks(){return this._chunks}async unzip(){if(!Object.keys(this.files).length)for await(const t of x.unzip(new File([this.data],this.fileName)))this.files[t.name]=await t.content()}extractOpf(){if(this.opf)return;const t=g(this),s=t.parseXml("META-INF/container.xml").querySelector("rootfile").getAttribute("full-path");this.opfDir=s.split("/").slice(0,-1).join("/"),this.opf=t.parseXml(s);for(const i of this.opf.querySelectorAll("manifest > item"))this.manifest[i.getAttribute("id")]={href:i.getAttribute("href"),mimeType:i.getAttribute("media-type")}}parseXml(t){if(!(t in this.files))throw new Error(`EPUB: trying to access non-existing file ${t}`);return new DOMParser().parseFromString(new TextDecoder().decode(this.files[t]),"text/xml")}getAbsPath(t){return[this.opfDir,t].filter(Boolean).join("/")}parseXmlAbs(t){return t=this.getAbsPath(t),this.parseXml(t)}parseXmlId(t){const e=this.manifest[t]?.href;return this.parseXmlAbs(e)}async parseInfo(){const t=g(this);await t.unzip(),t.extractOpf();const e=t.opf.querySelector("metadata");if(e){for(const i of e.children)if(i.tagName.toLowerCase().startsWith("dc:")){const c={text:i.textContent};for(const l of i.attributes)if(l.name.startsWith("opf:")){const m=l.name.slice(4).replace(/-\w/,f=>f[1].toUpperCase());c[m]=l.value}(t.meta[i.localName]??=[]).push(c)}}t.title=t.meta.title?.[0]?.text??t.fileName,t.author=t.meta.creator?.[0]?.text??"";const s=t.manifest[e?.querySelector('meta[name="cover"]')?.getAttribute("content")??""];if(s){const{ImageUtils:i}=await y(async()=>{const{ImageUtils:c}=await import("./image-CLWBAFAA.js");return{ImageUtils:c}},[]);this.thumbnailUrl=await i.scaleToDataURL(t.files[this.getAbsPath(s.href)],s.mimeType,3e4,300,"jpeg")}}async parseData(){const t=new Set(["p","div","section","article","li","blockquote"]),e=g(this);await e.unzip(),e.extractOpf();let s;const i=this.opf.querySelector("spine[toc]");if(i){const r=i.getAttribute("toc"),o=e.parseXmlId(r),h=(n,u=0)=>{for(const a of n.children)if(a.localName==="navPoint"){const p=a.querySelector("navLabel>text")?.textContent,d=a.querySelector("content")?.getAttribute("src");d&&p&&(s??={},s[this.getAbsPath(d)]={text:p,level:u}),h(a,u+1)}};h(o.querySelector("navMap"))}for(const[r,o]of Object.entries(e.files))/\.(png|jpe?g|gif|svg)$/i.test(r)&&(e.resources[r]=new Blob([o]));let c,l=null;const m="https://fake.com/";for(const r of this.opf.querySelectorAll("spine > itemref")){const o=r.getAttribute("idref");c=this.getAbsPath(this.manifest[o].href);const h=this.parseXml(c);l=s?.[c],f(h.body)}return await Promise.all(e.loaders.map(r=>r())),this;function f(r){let o="";if(!r.childNodes.length)return r.textContent??"";for(const n of r.childNodes)if(n instanceof Element){const u=n.getAttribute("id");if(u&&s){const a=c+"#"+u;l=s[a]}if(n.localName==="svg")continue;if(n.localName==="img"||n.localName==="image"){const a=n.getAttribute("src");if(!a)continue;h(),e.addChunk({type:"image",href:new URL(a,m+c).href.slice(m.length)},v);continue}if(/^h[1-6]$/.test(n.localName)){h(n.textContent??"","title");continue}if(t.has(n.localName)){o+=f(n),h();continue}o+=f(n)}else o+=f(n);return o;function h(n,u){if(o.length){const d=o;o="",h(d,"p")}const a=n?.trim();if(!a)return;const p=e.addChunk({text:a,type:u});l&&(e.addOutlineChunk({text:l.text,chunkIdx:p.idx,level:l.level}),l=null)}}}}export{C as ItemEpub,C as default};
