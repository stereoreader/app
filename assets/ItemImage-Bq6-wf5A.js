import{I as D,t as S,C as T,g as R,h as M}from"./index-C2G1K13l.js";class O extends T{constructor(a){super(a)}get aspectRatio(){return this.item.settings.isStereo?this.pageWidth/2/this.pageHeight:this.pageWidth/this.pageHeight}calcRow(a,i,l){const s=l/this.aspectRatio+R.chunkGap;return i.push({offset:a,height:s,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:s}),s}component({lines:a,width:i,columnIdx:l},s){if(this.item.settings.backgroundMode)return[M("div")];const f={display:"flex",alignItems:"center",justifyContent:R.noStereo?"center":l?"left":"right"},p={backgroundRepeat:"no-repeat",backgroundImage:`url(${this.url})`,backgroundSize:"cover",backgroundPosition:(this.item.settings.isStereo&&l?"right":"left")+" center"};this.item.settings.fitWidth?(p.height=s.height-R.chunkGap+"px",p.width="100%",f.height=Math.max(window.innerHeight,s.height-R.chunkGap)+"px"):(p.height=Math.min(this.bitmap.height,s.height-R.chunkGap)+"px",p.width=Math.min(this.bitmap.width/(this.item.settings.isStereo?2:1),i)+"px",f.height=Math.max(window.innerHeight,parseInt(p.width)/this.aspectRatio)+"px");const b=M("div",{style:p});return[M("div",{idx:a?.[0],style:f},[b])]}}const E=new Set(["fontSize","readingProgress","fontWeight","alternateCharOpacity"]);class z extends D{get iconColor(){return"#FFC22B"}get icon(){return"image"}get listItemBackground(){return"#443322"}get settingsToStore(){return["width","gap","noStereo","showLineNumbers"]}get recalcProps(){return[this.settings.isStereo]}supports(a){return!E.has(a)}constructor(){super();const a=["length"];for(const i of a)Object.defineProperty(this,i,{writable:!0,configurable:!1,enumerable:!1,value:this[i]});this.settings.fitWidth??=!0}async parseInfo(){this.thumbnailUrl=await W(this.data,this.mimeType,100,100)}async parseData(){const a=S(this),i=new Blob([a.data],{type:a.mimeType}),l=await createImageBitmap(i);return a._chunks.push(new O({blob:i,bitmap:l,url:URL.createObjectURL(i),offset:0,idx:a._chunks.length,pageIdx:0,pageWidth:l.width,pageHeight:l.height,item:a})),Object.assign(a,{length:1}),this}get chunks(){return this._chunks}async addDepthMap(a){const i=this.chunks[0].blob,l=await u(i),s=await m(a,l.width,l.height),f=await U({source:i,depthMap:s,displaceByPixels:200}),p=await U({source:i,depthMap:s,displaceByPixels:-200}),b=await u(f),I=await u(p),k=b.width,v=b.height,t=new OffscreenCanvas(k*2,v),r=t.getContext("2d");r.drawImage(b,0,0),r.drawImage(I,k,0);const d=await t.convertToBlob({type:"image/png"}),c=g(this.fileName)+"-stereo.png";e(d,c);async function u(o){return await createImageBitmap(o)}async function m(o,h,w){const n=await createImageBitmap(o,{resizeWidth:h,resizeHeight:w,resizeQuality:"high"}),y=new OffscreenCanvas(h,w);return y.getContext("2d").drawImage(n,0,0),await y.convertToBlob({type:"image/png"})}function g(o){const h=o.lastIndexOf(".");return h===-1?o:o.slice(0,h)}function e(o,h){const w=URL.createObjectURL(o),n=document.createElement("div");n.style.position="fixed",n.style.right="16px",n.style.bottom="16px",n.style.padding="12px 16px",n.style.background="#1e1e1e",n.style.border="1px solid #444",n.style.borderRadius="6px",n.style.zIndex="9999",n.style.fontFamily="system-ui, sans-serif",n.style.fontSize="13px",n.style.color="#fff";const y=document.createElement("div");y.textContent="Stereo image ready",y.style.marginBottom="6px";const x=document.createElement("a");x.href=w,x.download=h,x.textContent="Download",x.style.color="#4ea1ff",x.style.textDecoration="underline",x.style.cursor="pointer";const C=document.createElement("span");C.textContent="Ã—",C.style.marginLeft="12px",C.style.cursor="pointer",C.style.color="#aaa",C.onclick=()=>{n.remove(),URL.revokeObjectURL(w)},n.appendChild(y),n.appendChild(x),n.appendChild(C),document.body.appendChild(n)}}}async function W(B,a,i,l){const s=await f(B,a);try{const{width:t,height:r}=s;if(t===0||r===0)throw new Error("Decoded image has zero dimensions.");const d=Math.min(i/t,l/r),c=Math.max(1,Math.round(t*d)),u=Math.max(1,Math.round(r*d)),{canvas:m,ctx:g}=p(c,u);return g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.clearRect(0,0,c,u),g.drawImage(s,0,0,c,u),await k(m)}finally{try{typeof s.close=="function"&&s.close()}catch{}}async function f(t,r){const d=new Blob([t],{type:r});return typeof createImageBitmap=="function"?await createImageBitmap(d):await new Promise((c,u)=>{const m=URL.createObjectURL(d),g=new Image;g.onload=async()=>{try{const{canvas:e,ctx:o}=p(g.naturalWidth,g.naturalHeight);o.drawImage(g,0,0),URL.revokeObjectURL(m);const h=await b(e);c(h)}catch(e){u(e)}},g.onerror=()=>{URL.revokeObjectURL(m),u(new Error("Failed to decode image."))},g.src=m})}function p(t,r){if(typeof OffscreenCanvas<"u"){const u=new OffscreenCanvas(t,r),m=u.getContext("2d");if(!m)throw new Error("Could not get 2D context.");return{canvas:u,ctx:m}}const d=document.createElement("canvas");d.width=t,d.height=r;const c=d.getContext("2d");if(!c)throw new Error("Could not get 2D context.");return{canvas:d,ctx:c}}async function b(t){if("transferToImageBitmap"in t&&typeof t.transferToImageBitmap=="function")return t.transferToImageBitmap();const r=await I(t);return await createImageBitmap(r)}async function I(t){return"convertToBlob"in t&&typeof t.convertToBlob=="function"?await t.convertToBlob({type:"image/png"}):await new Promise((r,d)=>{t.toBlob(c=>{if(!c){d(new Error("Canvas toBlob failed."));return}r(c)},"image/png")})}async function k(t){if(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)return t.toDataURL("image/png");const r=await I(t);return await v(r)}function v(t){return new Promise((r,d)=>{const c=new FileReader;c.onload=()=>r(String(c.result)),c.onerror=()=>d(new Error("Failed to read blob as data URL.")),c.readAsDataURL(t)})}}async function U(B){const a=Math.min(6,navigator.hardwareConcurrency||1),i=await u(B.source),l=await u(B.depthMap);if(i.width!==l.width||i.height!==l.height)throw new Error("Source and depth map dimensions must match");const s=i.width,f=i.height,p=m(i),b=m(l),I=Math.ceil(f/a),k=[];for(let e=0;e<a;e++){const o=e*I,h=Math.min(f,o+I);if(o>=h)break;const w=g(p.data,s,o,h),n=g(b.data,s,o,h),y=c(),x=new Promise(C=>{y.onmessage=L=>{const P=new Uint8ClampedArray(L.data.buffer);C(new ImageData(P,s,h-o)),y.terminate()}});y.postMessage({source:w.buffer,depth:n.buffer,width:s,height:h-o,displaceByPixels:B.displaceByPixels},[w.buffer,n.buffer]),k.push(x)}const v=await Promise.all(k),t=new OffscreenCanvas(s,f),r=t.getContext("2d");let d=0;for(const e of v)r.putImageData(e,0,d),d+=e.height;return await t.convertToBlob({type:"image/png"});function c(){const e=`
self.onmessage = e => {
    const { source, depth, width, height, displaceByPixels } = e.data;

    const src = new Uint8ClampedArray(source);
    const dep = new Uint8ClampedArray(depth);
    const out = new Uint8ClampedArray(src.length);

    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            const d = dep[i] / 255;
            const dx = Math.round(d * displaceByPixels);
            const sx = Math.min(width - 1, Math.max(0, x + dx));
            const si = (y * width + sx) * 4;

            out[i]     = src[si];
            out[i + 1] = src[si + 1];
            out[i + 2] = src[si + 2];
            out[i + 3] = src[si + 3];
        }
    }

    self.postMessage({ buffer: out.buffer }, [out.buffer]);
};
        `,o=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(o))}async function u(e){return await createImageBitmap(e)}function m(e){const h=new OffscreenCanvas(e.width,e.height).getContext("2d");return h.drawImage(e,0,0),h.getImageData(0,0,e.width,e.height)}function g(e,o,h,w){const n=o*4;return e.slice(h*n,w*n)}}export{z as ItemImage,z as default,U as displacePixels,W as scaleImageToPngDataURL};
