import{I as f,t as p,C as w,g,h as b}from"./index-BJIvwIoY.js";class y extends w{calcRow(t,n,a){const o=a/this.aspectRatio+g.chunkGap;return n.push({offset:t,height:o,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:o}),o}component({lines:t,width:n},a){const o={backgroundPosition:"center",backgroundRepeat:"no-repeat",height:a.height-g.chunkGap+"px",backgroundImage:`url(${this.url})`,backgroundSize:"cover"};return[b("div",{idx:t?.[0],style:o})]}}class k extends f{iconColor="#FFC22B";icon="image";settingsToStore=["width","gap","noStereo"];supports(t){return t!=="fontSize"}constructor(){super();const t=["length","url"];for(const n of t)Object.defineProperty(this,n,{writable:!0,configurable:!1,enumerable:!1,value:this[n]})}async parseInfo(){this.thumbnailUrl=await x(this.data,this.mimeType,100,100)}async parseData(){const t=p(this),n=new Blob([t.data],{type:t.mimeType}),a=this.url??=URL.createObjectURL(n),{promise:o,resolve:i,reject:s}=Promise.withResolvers(),r=new Image;return r.src=a,r.onload=i,r.onerror=s,await o,t._chunks.push(new y({offset:0,idx:t._chunks.length,url:a,pageIdx:0,pageWidth:r.naturalWidth,pageHeight:r.naturalHeight,aspectRatio:r.naturalWidth/r.naturalHeight,item:t})),Object.assign(t,{length:1}),this}get chunks(){return this._chunks}}async function x(e,t,n,a){const o=await R(e,t);try{const{width:i,height:s}=o;if(i===0||s===0)throw new Error("Decoded image has zero dimensions.");const r=Math.min(n/i,a/s),c=Math.max(1,Math.round(i*r)),u=Math.max(1,Math.round(s*r)),{canvas:d,ctx:l}=h(c,u);return l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.clearRect(0,0,c,u),l.drawImage(o,0,0,c,u),await v(d)}finally{try{typeof o.close=="function"&&o.close()}catch{}}}async function R(e,t){const n=new Blob([e],{type:t});return typeof createImageBitmap=="function"?await createImageBitmap(n):await new Promise((a,o)=>{const i=URL.createObjectURL(n),s=new Image;s.onload=async()=>{try{const{canvas:r,ctx:c}=h(s.naturalWidth,s.naturalHeight);c.drawImage(s,0,0),URL.revokeObjectURL(i);const u=await I(r);a(u)}catch(r){o(r)}},s.onerror=()=>{URL.revokeObjectURL(i),o(new Error("Failed to decode image."))},s.src=i})}function h(e,t){if(typeof OffscreenCanvas<"u"){const o=new OffscreenCanvas(e,t),i=o.getContext("2d");if(!i)throw new Error("Could not get 2D context.");return{canvas:o,ctx:i}}const n=document.createElement("canvas");n.width=e,n.height=t;const a=n.getContext("2d");if(!a)throw new Error("Could not get 2D context.");return{canvas:n,ctx:a}}async function I(e){if("transferToImageBitmap"in e&&typeof e.transferToImageBitmap=="function")return e.transferToImageBitmap();const t=await m(e);return await createImageBitmap(t)}async function m(e){return"convertToBlob"in e&&typeof e.convertToBlob=="function"?await e.convertToBlob({type:"image/png"}):await new Promise((t,n)=>{e.toBlob(a=>{if(!a){n(new Error("Canvas toBlob failed."));return}t(a)},"image/png")})}async function v(e){if(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)return e.toDataURL("image/png");const t=await m(e);return await C(t)}function C(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>t(String(a.result)),a.onerror=()=>n(new Error("Failed to read blob as data URL.")),a.readAsDataURL(e)})}export{k as ItemImage,k as default,x as scaleImageToPngDataURL};
