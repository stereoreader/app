import{I,t as k,C as v,g as f,h as w}from"./index-Bp8MPjk2.js";class B extends v{constructor(e){super(e)}get aspectRatio(){return this.item.settings.isStereo?this.pageWidth/2/this.pageHeight:this.pageWidth/this.pageHeight}calcRow(e,o,c){const r=c/this.aspectRatio+f.chunkGap;return o.push({offset:e,height:r,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:r}),r}component({lines:e,width:o,columnIdx:c},r){if(this.item.settings.backgroundMode)return[w("div")];const l={height:Math.max(window.innerHeight,r.height-f.chunkGap)+"px",display:"flex",alignItems:"center",justifyContent:c?"left":"right"},u={backgroundRepeat:"no-repeat",height:Math.min(this.bitmap.height,r.height-f.chunkGap)+"px",width:Math.min(this.bitmap.width/(this.item.settings.isStereo?2:1),o)+"px",backgroundImage:`url(${this.url})`,backgroundSize:"cover",backgroundPosition:(this.item.settings.isStereo&&c?"right":"left")+" center"},p=w("div",{style:u});return[w("div",{idx:e?.[0],style:l},[p])]}}const L=new Set(["fontSize","readingProgress","fontWeight","alternateCharOpacity"]);class U extends I{iconColor="#FFC22B";icon="image";get settingsToStore(){return["width","gap","noStereo","showLineNumbers"]}get recalcProps(){return[this.settings.isStereo]}supports(e){return!L.has(e)}constructor(){super();const e=["length"];for(const o of e)Object.defineProperty(this,o,{writable:!0,configurable:!1,enumerable:!1,value:this[o]})}async parseInfo(){this.thumbnailUrl=await T(this.data,this.mimeType,100,100)}async parseData(){const e=k(this),o=new Blob([e.data],{type:e.mimeType}),c=await createImageBitmap(o);return e._chunks.push(new B({blob:o,bitmap:c,url:URL.createObjectURL(o),offset:0,idx:e._chunks.length,pageIdx:0,pageWidth:c.width,pageHeight:c.height,item:e})),Object.assign(e,{length:1}),this}get chunks(){return this._chunks}}async function T(m,e,o,c){const r=await l(m,e);try{const{width:t,height:n}=r;if(t===0||n===0)throw new Error("Decoded image has zero dimensions.");const i=Math.min(o/t,c/n),a=Math.max(1,Math.round(t*i)),h=Math.max(1,Math.round(n*i)),{canvas:g,ctx:s}=u(a,h);return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.clearRect(0,0,a,h),s.drawImage(r,0,0,a,h),await y(g)}finally{try{typeof r.close=="function"&&r.close()}catch{}}async function l(t,n){const i=new Blob([t],{type:n});return typeof createImageBitmap=="function"?await createImageBitmap(i):await new Promise((a,h)=>{const g=URL.createObjectURL(i),s=new Image;s.onload=async()=>{try{const{canvas:d,ctx:R}=u(s.naturalWidth,s.naturalHeight);R.drawImage(s,0,0),URL.revokeObjectURL(g);const C=await p(d);a(C)}catch(d){h(d)}},s.onerror=()=>{URL.revokeObjectURL(g),h(new Error("Failed to decode image."))},s.src=g})}function u(t,n){if(typeof OffscreenCanvas<"u"){const h=new OffscreenCanvas(t,n),g=h.getContext("2d");if(!g)throw new Error("Could not get 2D context.");return{canvas:h,ctx:g}}const i=document.createElement("canvas");i.width=t,i.height=n;const a=i.getContext("2d");if(!a)throw new Error("Could not get 2D context.");return{canvas:i,ctx:a}}async function p(t){if("transferToImageBitmap"in t&&typeof t.transferToImageBitmap=="function")return t.transferToImageBitmap();const n=await b(t);return await createImageBitmap(n)}async function b(t){return"convertToBlob"in t&&typeof t.convertToBlob=="function"?await t.convertToBlob({type:"image/png"}):await new Promise((n,i)=>{t.toBlob(a=>{if(!a){i(new Error("Canvas toBlob failed."));return}n(a)},"image/png")})}async function y(t){if(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)return t.toDataURL("image/png");const n=await b(t);return await x(n)}function x(t){return new Promise((n,i)=>{const a=new FileReader;a.onload=()=>n(String(a.result)),a.onerror=()=>i(new Error("Failed to read blob as data URL.")),a.readAsDataURL(t)})}}export{U as ItemImage,U as default,T as scaleImageToPngDataURL};
