import{I,t as B,C as k,g as p,h as w}from"./index-DcrsOEob.js";class v extends k{constructor(e){super(e)}get aspectRatio(){return this.item.settings.isStereo?this.pageWidth/2/this.pageHeight:this.pageWidth/this.pageHeight}calcRow(e,r,c){const s=c/this.aspectRatio+p.chunkGap;return r.push({offset:e,height:s,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:s}),s}component({lines:e,width:r,columnIdx:c},s){if(this.item.settings.backgroundMode)return[w("div")];const l={backgroundRepeat:"no-repeat",height:s.height-p.chunkGap+"px",backgroundImage:`url(${this.url})`,backgroundSize:"cover",backgroundPosition:(this.item.settings.isStereo&&c?"right":"left")+" center"};return[w("div",{idx:e?.[0],style:l})]}}const L=new Set(["fontSize","readingProgress","fontWeight","alternateCharOpacity"]);class P extends I{iconColor="#FFC22B";icon="image";get settingsToStore(){return["width","gap","noStereo","showLineNumbers"]}get recalcProps(){return[this.settings.isStereo]}supports(e){return!L.has(e)}constructor(){super();const e=["length"];for(const r of e)Object.defineProperty(this,r,{writable:!0,configurable:!1,enumerable:!1,value:this[r]})}async parseInfo(){this.thumbnailUrl=await T(this.data,this.mimeType,100,100)}async parseData(){const e=B(this),r=new Blob([e.data],{type:e.mimeType}),c=await createImageBitmap(r);return e._chunks.push(new v({blob:r,bitmap:c,url:URL.createObjectURL(r),offset:0,idx:e._chunks.length,pageIdx:0,pageWidth:c.width,pageHeight:c.height,item:e})),Object.assign(e,{length:1}),this}get chunks(){return this._chunks}}async function T(h,e,r,c){const s=await l(h,e);try{const{width:t,height:n}=s;if(t===0||n===0)throw new Error("Decoded image has zero dimensions.");const o=Math.min(r/t,c/n),a=Math.max(1,Math.round(t*o)),g=Math.max(1,Math.round(n*o)),{canvas:u,ctx:i}=d(a,g);return i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.clearRect(0,0,a,g),i.drawImage(s,0,0,a,g),await y(u)}finally{try{typeof s.close=="function"&&s.close()}catch{}}async function l(t,n){const o=new Blob([t],{type:n});return typeof createImageBitmap=="function"?await createImageBitmap(o):await new Promise((a,g)=>{const u=URL.createObjectURL(o),i=new Image;i.onload=async()=>{try{const{canvas:m,ctx:R}=d(i.naturalWidth,i.naturalHeight);R.drawImage(i,0,0),URL.revokeObjectURL(u);const C=await b(m);a(C)}catch(m){g(m)}},i.onerror=()=>{URL.revokeObjectURL(u),g(new Error("Failed to decode image."))},i.src=u})}function d(t,n){if(typeof OffscreenCanvas<"u"){const g=new OffscreenCanvas(t,n),u=g.getContext("2d");if(!u)throw new Error("Could not get 2D context.");return{canvas:g,ctx:u}}const o=document.createElement("canvas");o.width=t,o.height=n;const a=o.getContext("2d");if(!a)throw new Error("Could not get 2D context.");return{canvas:o,ctx:a}}async function b(t){if("transferToImageBitmap"in t&&typeof t.transferToImageBitmap=="function")return t.transferToImageBitmap();const n=await f(t);return await createImageBitmap(n)}async function f(t){return"convertToBlob"in t&&typeof t.convertToBlob=="function"?await t.convertToBlob({type:"image/png"}):await new Promise((n,o)=>{t.toBlob(a=>{if(!a){o(new Error("Canvas toBlob failed."));return}n(a)},"image/png")})}async function y(t){if(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)return t.toDataURL("image/png");const n=await f(t);return await x(n)}function x(t){return new Promise((n,o)=>{const a=new FileReader;a.onload=()=>n(String(a.result)),a.onerror=()=>o(new Error("Failed to read blob as data URL.")),a.readAsDataURL(t)})}}export{P as ItemImage,P as default,T as scaleImageToPngDataURL};
