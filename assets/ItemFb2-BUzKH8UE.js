import{I as d,t as f,C as p,g as u,h as b}from"./index-Bu1jb_n3.js";class k extends p{width=0;height=0;get ratio(){return this.width/this.height}constructor(i){super(i),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const e=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!e)throw new Error("Cannot extract fb2 image href");const n=this.item.binaries[e],s=atob(n.textContent),c=new Array(s.length);for(let r=0;r<s.length;r++)c[r]=s.charCodeAt(r);const h=new Uint8Array(c),l=new Blob([h],{type:n.getAttribute("content-type")});this.url=URL.createObjectURL(l);const{promise:t,resolve:o}=Promise.withResolvers(),a=new Image;return a.onload=()=>{this.width=a.width,this.height=a.height,o()},a.src=this.url,t}calcRow(i,e,n){const{style:s}=this,c=Math.min(n,this.width)/this.ratio+u.chunkGapReal;return e.push({offset:i,height:c,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:c}),c}component=(i,e)=>{const n={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:e.height-u.chunkGapReal+"px",backgroundSize:"contain"},s=d.current.activeChunk.idx===this.idx;return s&&(n.backgroundColor=u.cursorBackgroundColor),[b("div",{idx:i?.lines?.[0],class:{active:s},style:n})]}}class y extends d{binaries={};loaders=[];get iconColor(){return"#44ff88"}get icon(){return"fb2-file"}constructor(){super();const i=["binaries","loaders"];for(const e of i)Object.defineProperty(this,e,{writable:!0,configurable:!1,enumerable:!1,value:this[e]})}async parseInfo(){await super.parseInfo();const i=new DOMParser().parseFromString(this.data,"text/xml"),e=i.documentElement.querySelector("description > title-info > book-title")?.textContent;e&&(this.title=e);const n=i.documentElement.querySelector("description > title-info > author");n&&(this.author=[...n.children].map(s=>s.textContent.trim()).filter(Boolean).join(" "))}async parseData(){const i=new DOMParser().parseFromString(this.data,"text/xml"),e=f(this);let n=0;const s=(t,o)=>{t.trim().match(/^\[?\s*\d+\s*\]?$/)&&(o="title");const a=e.addChunk({text:t,type:o});o==="title"&&t&&e.addOutlineChunk({text:t,chunkIdx:a.idx})},c=i.documentElement.querySelector("description > title-info > coverpage > image");c&&h([c],"description");for(const t of l(i.documentElement.children))t.tagName==="body"?h(t.children,"body"):t.tagName==="binary"&&(this.binaries[t.id]=t);return await Promise.all(e.loaders.map(t=>t())),this;function h(t,o){for(let a=0;a<t.length;a++){const r=t[a];if(r.tagName==="image"){const g=new k({offset:n,idx:e._chunks.length,elem:r,type:"image",item:e});e._chunks.push(g),n++}else r.tagName==="p"||!r.children.length?s(r.textContent,o):h(r.children,r.tagName)}}function*l(t){for(let o=0;o<t.length;o++)yield t[o]}}get chunks(){return this._chunks}}export{y as ItemFb2,y as default};
