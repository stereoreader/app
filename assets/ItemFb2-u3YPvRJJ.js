import{I as c,t as p,C as f,g as m,h as w,n as x}from"./index-Ch4bUAYH.js";class y extends f{async onClick(r){const e=this.item.outline;c.current=null,await x(),c.current=e,Object.assign(e.readingProgressDetails,{chunkIdx:this.chunkIdx,chunkPos:0,screenY:.01})}}class C extends f{width=0;height=0;get ratio(){return this.width/this.height}constructor(r){super(r),this.item.loaders.push(this.loadImage.bind(this))}loadImage(){const e=this.elem.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!e)throw new Error("Cannot extract fb2 image href");const i=this.item.binaries[e],o=atob(i.textContent),s=new Array(o.length);for(let n=0;n<o.length;n++)s[n]=o.charCodeAt(n);const u=new Uint8Array(s),l=new Blob([u],{type:i.getAttribute("content-type")});this.url=URL.createObjectURL(l);const{promise:a,resolve:g}=Promise.withResolvers(),t=new Image;return t.onload=()=>{this.width=t.width,this.height=t.height,g()},t.src=this.url,a}calcRow(r,e,i){const{style:o}=this,s=Math.min(i,this.width)/this.ratio+m.chunkGap;return e.push({offset:r,height:s,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],rowHeight:s}),s}component(r,e){const i={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:e.height-m.chunkGap+"px",backgroundSize:"contain"},o=c.current.activeChunk.idx===this.idx;return o&&(i.backgroundColor=m.cursorBackgroundColor),[w("div",{idx:r?.lines?.[0],class:{active:o},style:i})]}}class N extends c{binaries={};loaders=[];iconColor="#44ff88";constructor(){super();const r=["length","binaries","loaders"];for(const e of r)Object.defineProperty(this,e,{writable:!0,configurable:!1,enumerable:!1,value:this[e]})}async parseData(){const r=new DOMParser().parseFromString(this.data,"text/xml"),e=p(this);let i=0,o=0;const s=c.create({title:this.title,isOutline:!0,chunked:!0,mimeType:"text/fb2",id:this.id+"_outline"});e.outline=s,s.outline=e;const u=(t,n)=>{t.trim().match(/^\[?\s*\d+\s*\]?$/)&&(n="title"),e._chunks.push(new f({text:t,offset:i,idx:e._chunks.length,type:n,item:e})),i+=t.length,n==="title"&&(s._chunks.push(new y({chunkIdx:e._chunks.length-1,text:t,offset:o,idx:s._chunks.length,item:s,type:n})),o+=t.length)},l=r.documentElement.querySelector("description > title-info > coverpage > image");l&&a([l],"description");for(const t of g(r.documentElement.children))t.tagName==="body"?a(t.children,"body"):t.tagName==="binary"&&(this.binaries[t.id]=t);return Object.assign(e,{length:i}),await Promise.all(e.loaders.map(t=>t())),Object.assign(s,{length:o}),e.chunked=!0,this;function a(t,n){for(let d=0;d<t.length;d++){const h=t[d];if(h.tagName==="image"){const k=new C({offset:i,idx:e._chunks.length,elem:h,type:"image",item:e});e._chunks.push(k),i++}else h.tagName==="p"||!h.children.length?u(h.textContent,n):a(h.children,h.tagName)}}function*g(t){for(let n=0;n<t.length;n++)yield t[n]}}get chunks(){return this._chunks}}export{N as ItemFb2};
