import{I as m,t as f,C as p,g as d,h as b}from"./index-CFxDIEyc.js";import{ImageUtils as y}from"./image-D5phIayO.js";function*u(l){for(let t=0;t<l.length;t++)yield l[t]}class k extends p{width=0;height=0;get ratio(){return this.width/this.height}constructor(t){super(t),this.item.loaders.push(this.loadImage.bind(this))}async loadImage(){const t=this.item.loadBinary(this.elem);this.url=URL.createObjectURL(t);const{promise:n,resolve:r}=Promise.withResolvers(),e=new Image;return e.onload=()=>{this.width=e.width,this.height=e.height,r()},e.src=this.url,n}calcRow(t,n,r){const{style:e}=this,s=Math.min(r,this.width)/this.ratio+d.chunkGapReal;return n.push({offset:t,height:s,lines:[{idx:0,chunkPos:0,chunk:this,text:""}],lineHeight:s}),s}component=(t,n)=>{const r={backgroundImage:`url(${this.url})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",height:n.height-d.chunkGapReal+"px",backgroundSize:"contain"},e=m.current.activeChunk.idx===this.idx;return e&&(r.backgroundColor=d.cursorBackgroundColor),[b("div",{idx:t?.lines?.[0],class:{active:e},style:r})]}}class C extends m{binaries={};loaders=[];get iconColor(){return"#44ff88"}get icon(){return"fb2-file"}constructor(){super();const t=["binaries","loaders","parsed"];for(const n of t)Object.defineProperty(this,n,{writable:!0,configurable:!1,enumerable:!1,value:this[n]})}loadBinary(t){const r=t.getAttributeNS("http://www.w3.org/1999/xlink","href")?.slice(1);if(!r)throw new Error("Cannot extract fb2 image href");const e=this.binaries[r],s=atob(e.textContent),i=new Array(s.length);for(let o=0;o<s.length;o++)i[o]=s.charCodeAt(o);const a=new Uint8Array(i);return new Blob([a],{type:e.getAttribute("content-type")})}async parseInfo(){await super.parseInfo(),this.parsed=new DOMParser().parseFromString(this.data,"text/xml");for(const e of u(this.parsed.documentElement.children))e.tagName==="binary"&&(this.binaries[e.id]=e);const t=this.parsed.documentElement.querySelector("description > title-info > coverpage > image");if(t){const e=this.loadBinary(t);this.thumbnailUrl=await y.scaleToDataURL(e,null,3e4,300,"jpeg")}const n=this.parsed.documentElement.querySelector("description > title-info > book-title")?.textContent;n&&(this.title=n);const r=this.parsed.documentElement.querySelector("description > title-info > author");r&&(this.author=[...r.children].map(e=>e.textContent.trim()).filter(Boolean).join(" "))}async parseData(){const t=f(this);let n=0;if(!this.parsed){this.parsed=new DOMParser().parseFromString(this.data,"text/xml");for(const i of u(this.parsed.documentElement.children))i.tagName==="binary"&&(this.binaries[i.id]=i)}const r=(i,a,o)=>{a==="subtitle"&&(o++,a="title");const c=t.addChunk({text:i,type:a});a==="title"&&i&&t.addOutlineChunk({text:i,chunkIdx:c.idx,level:o})},e=this.parsed.documentElement.querySelector("description > title-info > coverpage > image");e&&s([e],"description");for(const i of u(this.parsed.documentElement.children))i.tagName==="body"&&s(i.children,"body");return await Promise.all(t.loaders.map(i=>i())),this;function s(i,a,o=0){for(let c=0;c<i.length;c++){const h=i[c];if(h.tagName==="image"){const g=new k({offset:n,idx:t._chunks.length,elem:h,type:"image",item:t});t._chunks.push(g),n++}else h.tagName==="p"||!h.children.length?r(h.textContent,a,o):s(h.children,h.tagName,o+1)}}}get chunks(){return this._chunks}}export{C as ItemFb2,C as default};
